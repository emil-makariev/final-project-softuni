<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM е зареден.");

    // Премахваме бутоните за увеличаване и намаляване
    const decreaseButtons = document.querySelectorAll('.fa-angle-left.dec');
    const increaseButtons = document.querySelectorAll('.fa-angle-right.inc');

    decreaseButtons.forEach(button => button.remove());
    increaseButtons.forEach(button => button.remove());


    const quantityInputs = document.querySelectorAll('.quantity-input');

        quantityInputs.forEach(inputElement => {
        let previousValue = parseInt(inputElement.value);
        const productId =  parseInt(inputElement.getAttribute('data-id'));
        const sizeId = parseInt(inputElement.getAttribute('data-size'));
        const maxQuantity = parseInt(inputElement.getAttribute('data-max-quantity'));

        console.log('Predishna stoinost:', previousValue)
        console.log('Product ID: ', productId)
        console.log('Size ID: ', sizeId)
        console.log('MAksimalno kol: ', maxQuantity)

        // Функция за актуализиране на състоянието на бутоните
        function updateButtonStates(inputElement) {
            const currentQuantity = parseInt(inputElement.value);
            const decreaseButton = inputElement.closest('.quantity-input-wrapper').querySelector('.decrease');
            const increaseButton = inputElement.closest('.quantity-input-wrapper').querySelector('.increase');



            // Ако количеството е 0 или достигнало максимума, блокираме съответните бутони
            if (currentQuantity <= 0 || currentQuantity >= maxQuantity) {
                decreaseButton.disabled = true;
                increaseButton.disabled = true;
            } else {
                decreaseButton.disabled = false;
                increaseButton.disabled = false;
            }
        }

        // Първоначално блокираме бутоните въз основа на текущото количество
        updateButtonStates(inputElement);

        inputElement.addEventListener('input', function () {
            const currentQuantity = parseInt(inputElement.value);

            // Ако стойността се е увеличила
            if (currentQuantity > previousValue) {
                addItemToOrder(productId, sizeId, currentQuantity);
            }

            // Ако стойността се е намалила
            if (currentQuantity < previousValue) {
                removeItemFromOrder(productId, sizeId);
            }

            // Записваме новата стойност като предишна за следващата промяна
            previousValue = currentQuantity;

            // Актуализираме състоянието на бутоните
            updateButtonStates(inputElement);
        });

        // Обработваме бутона за увеличение
        const increaseButton = inputElement.closest('.quantity-input-wrapper').querySelector('.increase');
        if (increaseButton) {
            increaseButton.addEventListener('click', function () {
                const currentQuantity = parseInt(inputElement.value);

                // Ако количеството е по-малко от максимума, увеличаваме количеството с 1
                if (currentQuantity < maxQuantity) {
                    inputElement.value = currentQuantity + 1;
                    updatePrice(inputElement, parseFloat(inputElement.getAttribute('data-price')), currentQuantity + 1);
                    addItemToOrder(productId, sizeId, currentQuantity + 1);
                }
            });
        }

        // Обработваме бутона за намаляване
        const decreaseButton = inputElement.closest('.quantity-input-wrapper').querySelector('.decrease');
        if (decreaseButton) {
            decreaseButton.addEventListener('click', function () {
                const currentQuantity = parseInt(inputElement.value);

                // Ако количеството е по-голямо от 1, намаляваме с 1
                if (currentQuantity > 1) {
                    inputElement.value = currentQuantity - 1;
                    updatePrice(inputElement, parseFloat(inputElement.getAttribute('data-price')), currentQuantity - 1);
                    removeItemFromOrder(productId, sizeId);
                }
            });
        }
    });

    // Функции за добавяне и премахване на продукти от количката
    function addItemToOrder(productId, sizeId, quantity) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/carts/add-to-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                size_id: sizeId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Item added to order:', data);
            updateCartTotal();
        })
        .catch(error => {
            console.error('Error adding item to order:', error);
        });
    }

    function removeItemFromOrder(productId, sizeId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/carts/remove-from-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                size_id: sizeId,
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Item removed from order:', data);
            updateCartTotal();
        })
        .catch(error => {
            console.error('Error removing item from order:', error);
        });
    }

    // Функция за актуализиране на цената на продукта
    function updatePrice(inputElement, price, currentQuantity) {
        const totalPrice = currentQuantity * price;
        const totalPriceElement = document.getElementById('total-price-' + inputElement.getAttribute('data-id') + '-' + inputElement.getAttribute('data-size'));
        totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
    }

    // Актуализиране на общата стойност на количката
    function updateCartTotal() {
        fetch(`/carts/update-cart-total/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const totalPriceElement = document.getElementById('cart-total-price');
                totalPriceElement.textContent = `$${data.total_price.toFixed(2)}`;
            }
        })
        .catch(error => {
            console.error('Error updating cart total:', error);
        });
    }
});
</script>