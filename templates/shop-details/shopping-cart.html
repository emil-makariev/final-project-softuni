{% extends 'base.html' %}
{% load static %}
{% block content %}
    <style>
        .hidden {
            display: none;
        }
    </style>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Shopping Cart</h4>
                    <div class="breadcrumb__links">
                        <a href="{% url 'common' %}">Home</a>
                        <a href="{% url 'all-products' %}">Shop</a>
                        <span>Shopping Cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Shopping Cart Section Begin -->
<section class="shopping-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="shopping__cart__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in product_data %}
                            <tr>
                                <td class="product__cart__item">
                                    <div class="product__cart__item__pic">
                                        <img src="{{ item.product.main_image.url }}" alt="">
                                    </div>
                                    <div class="product__cart__item__text">
                                        <h6>{{ item.product.name }}</h6>
                                        Product size is: <h6>{{ item.size_text }}</h6>
                                        <h5 class="product-price">${{ item.product.price }}</h5>
                                    </div>
                                </td>
                                <td class="quantity__item">
                                    <div class="quantity">
                                        <div class="pro-qty-2">
                                            <!-- Поле за количеството, с тип number -->
                                            <input type="number"
                                                   value="{{ item.count }}"
                                                   class="quantity-input"
                                                   data-price="{{ item.product.price }}"
                                                   data-id="{{ item.product.id }}"
                                                   data-size="{{ item.size.id }}"
                                                   {% if item.product.accessory%}
                                                        data-max-quantity="{{ item.product.accessory.max_quantity_accessory }}"
                                                        min="1" max="{{ item.product.accessory.max_quantity_accessory }}">
                                                   {% else %}
                                                        data-max-quantity="{{ item.max_quantity }}"
                                                        min="1" max="{{ item.max_quantity }}">
                                                   {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="cart__price">
                                    <span class="total-price" id="total-price-{{ item.product.id }}-{{ item.size.id }}">${{ price_for_a_singe_product|floatformat:2 }}</span>
                                </td>
                                <td class="cart__close"><i class="fa fa-close"></i></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="continue__btn">
                            <a href="{% url 'all-products' %}">Continue Shopping</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="cart__total">
                    <h6>Cart total</h6>
                    <ul>
                        <li>Subtotal <span id="cart-total-price"></span></li>
                        <li>Total <span id="cart-total-price"></span></li>
                    </ul>
                    <a href="#" class="primary-btn">Proceed to checkout</a>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Shopping Cart Section End -->

<script>

document.addEventListener("DOMContentLoaded", function () {
    const decreaseButtons = document.querySelectorAll('.fa-angle-left.dec');
    const increaseButtons = document.querySelectorAll('.fa-angle-right.inc');

    decreaseButtons.forEach(button => button.remove());
    increaseButtons.forEach(button => button.remove());

    const quantityInputs = document.querySelectorAll('.quantity-input');
    const removeButtons = document.querySelectorAll('.cart__close');

        function initializePrices() {
        quantityInputs.forEach(inputElement => {
            console.log('Input Element: ', inputElement)

            const priceForSingleProduct = parseFloat(inputElement.getAttribute('data-price'));
            console.log('Price for a single product: ', priceForSingleProduct)

            const currentQuantity = parseInt(inputElement.value);
            console.log('Current Quantity: ', currentQuantity)

            updatePrice(inputElement, priceForSingleProduct, currentQuantity);
            updateCartTotal(inputElement, priceForSingleProduct, currentQuantity);
        });
    }

    // Обновяване на цената за всеки продукт
    function updatePrice(inputElement, priceForSingleProduct, currentQuantity) {
        console.log('Product was sent here')
        const totalPrice = currentQuantity * priceForSingleProduct;
        const totalPriceElement = document.getElementById('total-price-' + inputElement.getAttribute('data-id') + '-' + inputElement.getAttribute('data-size'));

        if (totalPriceElement) {
            totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
        }
    }

    // Инициализираме цените при зареждане на страницата
    initializePrices();

     removeButtons.forEach(button => {
        button.addEventListener('click', function () {
            // Намираме реда на продукта
            const row = button.closest('tr');

            // Вземаме productId и sizeId от съответните атрибути
            const productId = row.querySelector('.quantity-input').getAttribute('data-id');
            const sizeId = row.querySelector('.quantity-input').getAttribute('data-size');

            // Потвърждаваме с потребителя, че наистина иска да премахне всички продукти със същия размер
            if (confirm('Are you sure you want to remove all products with this size from the cart?')) {
                // Изпращаме AJAX заявка за премахване
                DeleteItemFromOrder(productId, sizeId);

                // Премахваме реда от DOM
                row.remove();
            }
        });
    });



    quantityInputs.forEach(inputElement => {
        let previousValue = parseInt(inputElement.value);
        let currentQuantity = parseInt(inputElement.value);
        console.log('Current Quantity: ', currentQuantity);

        inputElement.addEventListener('input', function () {
            let currentQuantity = parseInt(inputElement.value);
            const productId = parseInt(inputElement.getAttribute('data-id'));
            const sizeId = parseInt(inputElement.getAttribute('data-size'));

            if (currentQuantity !== previousValue) {
                if (currentQuantity > previousValue) {
                    addItemToOrder(productId, sizeId, currentQuantity);
                }
                else if (currentQuantity < previousValue) {
                    removeItemFromOrder(productId, sizeId, currentQuantity);
                }

                const priceForSingleProduct = parseFloat(inputElement.getAttribute('data-price'));
                updatePrice(inputElement, priceForSingleProduct, currentQuantity);

                previousValue = currentQuantity;  // Актуализираме стойността на предишното количество
            }
        });
    });
            function updatePrice(inputElement, priceForSingleProduct, currentQuantity) {
            const totalPrice = currentQuantity * priceForSingleProduct;
            const totalPriceElement = document.getElementById('total-price-' + inputElement.getAttribute('data-id') + '-' + inputElement.getAttribute('data-size'));

            if (totalPriceElement) {
                totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
            }
        }

    function DeleteItemFromOrder(productId, sizeId, quantity) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log('Product ID:', productId);
    console.log('Size ID:', sizeId);
    console.log('Quantity:', quantity);

    // Създаваме request body с основните параметри
    const requestBody = {
        product_id: productId
    };

    // Добавяме size_id и quantity само ако са налични
    if (sizeId) {
        requestBody.size_id = sizeId;
    }
    if (quantity) {
        requestBody.quantity = quantity;
    }


    // Правим fetch заявката
    fetch('/carts/remove-product-from-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            // Ако не е успешен отговор (например 400 грешка)
            return response.json().then(data => {
                throw new Error(data.message || 'Something went wrong');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            console.log('Item successfully removed from order');
            updateCartTotal();  // Обновяваме общата стойност на количката
        } else {
            console.error('Error removing item from order:', data.message);
        }
    })
    .catch(error => {
        console.error('Error removing item from order:', error);
    });
}

    function addItemToOrder(productId, sizeId, quantity) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/carts/add-to-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                size_id: sizeId,
                quantity: quantity  // Изпращаме актуалното количество
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Item added to order:', data);
            updateCartTotal();  // Актуализираме общата сума след добавянето
        })
        .catch(error => {
            console.error('Error adding item to order:', error);
        });
    }

    // Функция за премахване на продукт от количката
    function removeItemFromOrder(productId, sizeId, quantity) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/carts/remove-from-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                size_id: sizeId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Item removed from order:', data);
            updateCartTotal();  // Актуализираме общата сума след премахването
        })
        .catch(error => {
            console.error('Error removing item from order:', error);
        });
    }


    // Функция за актуализиране на общата стойност на количката
    function updateCartTotal(inputElement, priceForSingleProduct, currentQuantity) {
        fetch('/carts/update-cart-total/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                data.cur_q = currentQuantity;
                const totalPriceElement = document.querySelectorAll('#cart-total-price');
                console.log(totalPriceElement)
                totalPriceElement.forEach(el => {
                    // Here, set the content for each element
                    el.textContent = `$${parseFloat(data.total_price).toFixed(2)}`;
                });


            }
        })
        .catch(error => {
            console.error('Error updating cart total:', error);
        });
    }
});
</script>

{% endblock %}
